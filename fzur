#!/usr/bin/env bash
# Requirements: aur-info.sh (needs jq), base-devel, curl, fzf, git

set -euo pipefail
shopt -s expand_aliases

CACHE_DIR=${XDG_CACHE_HOME:-$HOME/.cache}/fzur
PKGS_DIR="$CACHE_DIR/pkgbuild"
SCRIPT_DIR=$(pwd)

bold=$(tput bold)
reset=$(tput sgr0)
alias fzf="fzf --reverse --header-first --preview-window 75%,wrap"

update_repo() {
    if [ $# -lt 1 ]; then
        echo "update_repo: No package name provided." && exit 1
    fi
    mkdir -p "$PKGS_DIR"
    cd "$PKGS_DIR"
    if [ -d "$1" ]; then
        cd "$1"
        git pull --quiet
    else
        git clone "https://aur.archlinux.org/$1"
        cd "$1"
    fi
}

download_aur_list() {
    mkdir -p "$CACHE_DIR"
    cd "$CACHE_DIR"
    echo -e "${bold}Downloading AUR package list...\n${reset}"
    curl https://aur.archlinux.org/packages.gz | gzip -d > packages.txt
}

get_dependencies() {
    update_repo "$1"
    for dep in $(grep -Po '^\s*(make)?depends = \K[\w\-\.]+' .SRCINFO); do
        [ "$(pacman -Qqs "^$dep$")" ] && continue
        if [ "$(pacman -Ssq "^$dep$")" ]; then
            pacman_pkgs+=("$dep")
        else
            aur_pkgs+=("$dep")
            get_dependencies "$dep"
        fi
    done
}

aur_install() {
    if [ ! "$1" ]; then
        echo "aur_install: No packages provided." && exit 1
    fi
    aur_pkgs=()
    pacman_pkgs=()

    echo "Selected: $1"
    for selected in $1; do
        if [ "$(pacman -Ssq "^$selected$")" ]; then
            pacman_pkgs+=("$selected")
        else
            aur_pkgs+=("$selected")
            get_dependencies "$selected"
        fi
    done

    if [ ${#pacman_pkgs[@]} -gt 0 ]; then
        sudo pacman -S --asdeps --needed "${pacman_pkgs[@]}"
    fi

    if [ ${#aur_pkgs[@]} -gt 0 ]; then
        echo AUR packages: "${aur_pkgs[@]}"

        printf "%s\n" "${aur_pkgs[@]}" | fzf --preview "cat $PKGS_DIR/{1}/PKGBUILD" \
            --header $'PKGBUILDs\nEnter: Accept all\nEscape: Cancel'

        for pkg in "${aur_pkgs[@]}"; do
            cd "$PKGS_DIR/$pkg"

            # TODO: Add flag validation
            makepkg "$@"
            built_pkgs+="$(makepkg --packagelist | grep -v '\-debug.*-any.pkg.tar.zst') "
        done

        # Should be word split
        sudo pacman -U --asdeps $(echo "$built_pkgs" | xargs)
    fi
    sudo pacman -Dq --asexplicit $1
}

aur_select() {
    [ -f "$CACHE_DIR/packages.txt" ] || download_aur_list
    pkgs=$(pacman -Ssq | cat - "$CACHE_DIR/packages.txt" | fzf -m --header 'AUR packages to install' \
        --preview "$SCRIPT_DIR/aur-info.sh {}" | xargs)
    aur_install "$pkgs" "$@"
}

function aur_update {
    sudo pacman -Syu
    updates=()
    echo "Checking for AUR updates..."

    for pkg in $(pacman -Qqm | grep -v '\-debug$'); do
        update_repo "$pkg"
        # https://unix.stackexchange.com/a/327811
        installed_version=$(pacman -Qi "$pkg" | awk '/^Version/{print $3}')
        new_version=$(awk '/^\s*pkgver/{ver=$3} /^\s*pkgrel/{print ver "-" $3}' .SRCINFO)
        if [ "$(grep epoch .SRCINFO)" ]; then
            new_version="$(awk '/^\s*epoch/{print $3}' .SRCINFO):$new_version"
        fi
        if [ "$(vercmp "$installed_version" "$new_version")" -lt 0 ]; then
            updates+=("$pkg ($installed_version => $new_version)")
        fi
    done

    if [ "${#updates[@]}" -eq 0 ]; then
        echo "Up to date" && exit
    fi

    aur_install "$(printf "%s\n" "${updates[@]}" | fzf --accept-nth 1 -m \
        --header 'AUR packages to update' --bind 'load:select-all' | xargs)" "$@"
}

[ $# -eq 0 ] && set -- -i

# https://linuxize.com/post/bash-case-statement/
case $1 in
    '-c' | '--clean')
        # TODO: Keep repos for installed packages by default
        rm -rf "$CACHE_DIR";;
    '-i' | '--install')
        shift
        aur_select "$@"
        ;;
    '-r' | '--remove')
        pkgs=($(pacman -Qeq | fzf -m --preview 'pacman -Qi {1}'))
        [ "${#pkgs[@]}" -gt 0 ] || exit
        echo Selected for removal: "${pkgs[@]}"
        sudo pacman -Rns "${pkgs[@]}"
        ;;
    '-s' | '--sync')
        rm -rf "$CACHE_DIR/info"
        download_aur_list
        ;;
    '-u' | '--update')
        shift
        aur_update "$@"
        ;;
    *)
        echo -e 'Usage: fzur [options]\n'
        echo -e "-i, --install\tSelect and install packages with fzf (default)"
        echo -e "-u, --update\tSelect and update packages with fzf"
        echo -e "-r, --remove\tSelect and remove pacakges and their dependencies with fzf"
        echo -e "-s, --sync\tRe-download the AUR package list and clear the info cache"
        echo -e "-c, --clean.\tClear the cache including all PKGBUILD repositories\n"
        echo "makepkg flags may be passed when using --install or --update"
        ;;
esac
